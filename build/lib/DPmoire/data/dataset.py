import numpy as np
import re

from ase import Atoms
from ase.io import write as asewrite
from ase.io import read as aseread
from ase.io.extxyz import read_extxyz
from ase.io.vasp import read_vasp_out
from ase.calculators.singlepoint import SinglePointCalculator

class Dataset:

    '''
    Dataset class to collect the AB_initio dataset generated by VASP_MLFF.
    '''

    nConfigs = 0
    data = {
        "positions":[],
        "forces":[],
        "cells":[],
        "symbols":[],
        "energies":[],
    }

    def __init__(self):
        pass

    def loadAll_AB(self, nSecs:int, includeDir:str, infileSTR:str="ML_ABN"):
        '''
        load all dataset from each stacking.
        '''
        for i in range(nSecs):
            for j in range(nSecs):
                self.loadDataset_AB(includeDir+"/"+str(i)+"_"+str(j)+"/"+infileSTR)

    def loadAll_OUTCAR(self, nSecs:int, freq, includeDir:str, infileSTR:str="OUTCAR"):
        '''
        load all dataset from each stacking.
        '''
        for i in range(nSecs):
            for j in range(nSecs):
                self.loadDataset_OUTCAR(includeDir+"/"+str(i)+"_"+str(j)+"/"+infileSTR, freq=freq)

    def loadDataset_AB(self, infileSTR):
        '''
        load dataset from ML_AB file of VASP_MLFF module.
        '''
        infile = open(infileSTR)
        for i, lines in enumerate(infile):
            if i == 4:
                #read the number of structure in this file.
                self.nConfigs += int(lines.split()[0])                      
                break
        dataset = infile.read()
        infile.close()
        #cut the file into pieces
        structures = re.split("\n+\s*Configuration num.\s*\d+\n",dataset)  
        #pop out the header
        structures.pop(0)
        #handle each configs
        for structure in structures:

            para = re.split("=+\n",structure)
            ntype = int(para[2].split("\n")[2])
            nAtom = int(para[3].split("\n")[2])
            elem = []
            nelem = []

            #read elements and how many atoms in each element
            for lines in para[3].split("\n")[6:6+ntype]:
                elem.append(lines.split()[0])
                nelem.append(int(lines.split()[1]))

            #read lattice vectors of each cell
            latV = []
            for lines in para[5].split("\n")[2:5]:
                lat = []
                for str in lines.split():
                    lat.append(float(str))
                latV.append(lat)
            self.data["cells"].append(latV)

            #read position of each atom
            pos = []
            symbol = []
            k = 0
            for i, lines in enumerate(para[6].split("\n")[2:2+nAtom]):
                posP = []
                for str in lines.split():
                    posP.append(float(str))
                pos.append(posP)
                #and assign the element symbol to them.
                if(nelem[k]>0):
                    nelem[k] -= 1
                else:
                    k += 1
                symbol.append(elem[k])
            self.data["positions"].append(pos)
            self.data["symbols"].append(symbol)

            #read energy of each configuration
            self.data["energies"].append(float(para[7].split("\n")[2]))

            #read forces of each atom
            f = []
            for lines in para[8].split("\n")[2:2+nAtom]:
                fP = []
                for str in lines.split():
                    fP.append(float(str))
                f.append(fP)
            self.data["forces"].append(f)

    def loadDataset_OUTCAR(self, infileSTR, freq):
        '''
        Load dataset from vasp OUTCAR object using ase.io.read_vasp_out.
        Only capable for reading OUTCAR of relaxation or regular MD. 
        Invalid to read from OUTCAR of MLFF MODULE.
        '''
        outcarStructures = read_vasp_out(infileSTR, ":")
        for i, structure in enumerate(outcarStructures):
            if i%freq != 0:
                continue
            self.loadDataset_Atoms(structure)

    def loadDataset_extxyz(self, infileSTR):
        '''
        Load dataset from .extxyz file.
        '''        
        structures = aseread(infileSTR, format='extxyz', index=":")
        for structure in structures:
            self.loadDataset_Atoms(structure)

    def loadDataset_Atoms(self, structure):
        '''
        load dataset from ase.Atoms object.
        '''
        self.data["positions"].append(structure.get_positions())
        self.data["forces"].append(structure.get_forces())
        self.data["symbols"].append(structure.get_chemical_symbols())
        self.data["cells"].append(structure.get_cell().array)
        self.data["energies"].append(structure.get_total_energy())

    def save_extxyz(self, saveSTR):
        '''
        save the dataset to .extxyz file.
        Copied from github.
        '''
        #Clear the existing content in outfile.
        with open(saveSTR, "w") as fout:
            fout.write("")

        for idx in range(self.nConfigs):
            curr_atoms = Atoms(
            # set atomic positions
                positions=self.data["positions"][idx],
            # set cell in case it exists
                cell=self.data["cells"][idx],
            # set chemical symbols / species
                symbols=self.data["symbols"][idx], 
            # assuming data with periodic boundary conditions, set to false for e.g. for molecules in vacuum
                pbc=True
            )
            # set calculator to assign targets
            calculator = SinglePointCalculator(curr_atoms, energy=self.data["energies"][idx], forces=self.data["forces"][idx])
            curr_atoms.calc = calculator
            asewrite(saveSTR, curr_atoms, format='extxyz', append=True)